# Исправление проблемы с пустыми целями приглашений

## Проблема

Система пытается отправлять приглашения в Telegram целям, которые не содержат необходимых идентификаторов (username, phone_number, user_id_platform). Это приводит к ошибке 422 Unprocessable Entity от Integration Service.

## Диагностика

### 1. Запуск диагностики

```bash
# Диагностика всех целей
python debug_invite_targets.py

# Диагностика конкретной задачи
python debug_invite_targets.py <task_id>
```

Скрипт покажет:
- Сколько целей не содержат идентификаторов
- Статистику по заполненным полям
- Примеры пустых целей

### 2. Анализ логов

Проверьте логи invite-worker и integration-service на предмет сообщений:
```
Цель X не содержит идентификатора для приглашения
422 Unprocessable Entity
Необходимо указать target_username, target_phone или target_user_id
```

## Решение

### 1. Очистка пустых целей

```bash
# Просмотр пустых целей (без удаления)
python cleanup_empty_targets.py

# Просмотр пустых целей для конкретной задачи
python cleanup_empty_targets.py <task_id>

# Удаление пустых целей (ОСТОРОЖНО!)
python cleanup_empty_targets.py --execute

# Удаление пустых целей для конкретной задачи
python cleanup_empty_targets.py --execute <task_id>
```

### 2. Предотвращение в будущем

Система теперь содержит улучшенные проверки:
- Валидация при импорте из parsing-service
- Проверка целей перед обработкой в worker
- Строгая валидация в Telegram адаптере

## Проверка исправления

1. Запустите диагностику до и после очистки
2. Проверьте, что количество пустых целей уменьшилось
3. Перезапустите задачи приглашений
4. Убедитесь, что ошибки 422 больше не возникают

## Дополнительные меры

### Проверка parsing-service

Если продолжают поступать цели без идентификаторов, проверьте:
1. Работу парсеров Telegram - правильно ли они извлекают информацию об авторах
2. Настройки парсинга - возможно, нужно изменить параметры извлечения данных
3. Логи parsing-service на предмет ошибок извлечения авторов

### Мониторинг

Регулярно проверяйте:
- Наличие пустых целей в базе данных
- Ошибки в логах invite-worker
- Статистику успешных/неуспешных приглашений