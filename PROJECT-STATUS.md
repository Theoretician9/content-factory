# PROJECT-STATUS.md — Журнал изменений проекта

> **Этот файл — хронология изменений проекта. Здесь фиксируются все действия, изменения, проблемы и их решения, а также нерешённые вопросы. Каждая запись содержит дату, время, суть изменений, что было решено, что осталось. Также фиксируются следующие шаги. Ничего не удаляется — только добавляется новая информация.**
НИЧЕГО НЕ УДАЛЯЙ, ТОЛЬКО ДОБАВЛЯЙ ПРОГРЕСС
---

## 2024-05-26

- Проведена интеграция ELK Stack (Elasticsearch, Logstash, Kibana)
- Исправлены volume для logstash на абсолютные пути, чтобы контейнер видел реальные файлы логов
- Созданы тестовые логи, Logstash успешно обработал их, индекс logs-YYYY.MM.DD появился в Elasticsearch
- Kibana подключена, но поле Timestamp field неактивно при создании index pattern (будет решено после появления реальных логов)
- Все инфраструктурные проблемы с volume и путями решены
- Осталось: дождаться реальных логов, повторно настроить index pattern, создать визуализации и дашборды

# Следующие шаги

1. Дождаться появления реальных логов от сервисов (или настроить их генерацию)
2. После появления реальных логов — повторно настроить index pattern в Kibana, убедиться в наличии поля @timestamp
3. Настроить визуализации, фильтры и дашборды в Kibana
4. Продолжить настройку мониторинга, алертов и интеграций

---

## 2024-05-27

- Проведена полная очистка volumes и конфигов Vault, создана минимальная dev-конфигурация
- Vault успешно запущен в dev-режиме (root token: root, unsealed, доступен на 8201)
- Проверена доступность Vault через curl — сервис отвечает корректно
- Все сервисы могут обращаться к Vault по адресу http://vault:8201 с токеном root
- ⚠️ Зафиксировано: dev-режим Vault не предназначен для продакшена, все данные будут теряться при перезапуске. Перед продакшеном обязательно перейти на prod-конфиг с файловым backend, инициализацией и unseal-ключами
- Пункты чек-листа по Vault отмечены как выполненные (dev-режим для тестовой среды)
- Успешно интегрированы Grafana и Prometheus: Grafana видит Prometheus по адресу http://prometheus:9090
- Исправлена ошибка с пробелом в URL Prometheus в Grafana
- Проверена docker-сеть: Grafana и Prometheus находятся в одной сети, контейнеры видят друг друга
- Метрики с MySQL, RabbitMQ, Redis, backend-сервисов собираются, экспортеры работают
- Ошибки с правами MySQL экспортёра устранены (выданы права REPLICATION CLIENT, PROCESS)
- Базовая инфраструктура полностью функционирует, мониторинг работает
- Следующий шаг: настройка алертов в Alertmanager и создание пользовательских дашбордов в Grafana
- Проброс портов для всех админских сервисов (Grafana, Prometheus, Alertmanager, Kibana, Vault, RabbitMQ Management, Logstash Monitoring, Elasticsearch) осуществляется только на 127.0.0.1 сервера.
- Доступ к админским сервисам возможен только через SSH-туннель, наружу порты не проброшены.
- Все сервисы проверены через SSH-туннель, работают корректно.

---

## 2024-05-28

- Убран проброс портов наружу для админских сервисов (Grafana, Prometheus, Kibana, Alertmanager, Vault) в docker-compose.yml
- Теперь админские сервисы доступны только из внутренней docker-сети или через SSH-туннель
- Наружу открыты только 80 и 443 для публичных сервисов (API Gateway, фронт)
- Обновлены файлы PROJECT (актуальное описание инфраструктуры и безопасности) и check-list.md (отмечены выполненные пункты по закрытию портов и доступности админок)
- Следующий шаг — настройка firewall (разрешить только 22, 80, 443) и настройка HTTPS для публичных сервисов
- Выпущен и установлен HTTPS-сертификат Let's Encrypt для домена content-factory.xyz и www.content-factory.xyz.
- nginx настроен на работу с HTTPS, реализован автоматический редирект с http на https.
- Проверено: https://content-factory.xyz работает, сертификат валиден.
- Для автоматического продления сертификата используется команда: docker-compose run --rm certbot renew && docker-compose restart nginx (рекомендуется добавить в cron).
- Внесены изменения в nginx.conf и docker-compose.yml для поддержки Let's Encrypt и HTTPS.
- API Gateway интегрирован с Vault для хранения CSRF_SECRET_KEY и JWT_SECRET_KEY.
- Секреты добавлены в Vault через веб-интерфейс, значения прописаны в .env.
- Сервис перезапущен, ошибок по секретам нет, интеграция работает корректно.
- Продолжается поэтапный переход всех сервисов на централизованное хранение секретов в Vault.
- Swagger UI и ReDoc отключены во внешней среде, доступны только при DEBUG=true.
- OpenAPI JSON остаётся доступен для интеграций.
- Логирование (audit trail) теперь реализовано для login, logout, register, ошибок аутентификации. Все логи в формате JSON для Logstash/ELK.
- Security схемы (JWT, CSRF) описаны в OpenAPI/Swagger.
- Для /auth/login и /auth/register реализована строгая валидация входных данных по pydantic-схемам, ошибки валидации логируются, OpenAPI обновляется автоматически.
- Volume frontend-static для фронта теперь не анонимный, а локальная папка (./frontend-static:/usr/share/nginx/html:ro). Всё содержимое этой папки автоматически доступно nginx и на https://content-factory.xyz/.

---

## 2024-05-29

- Проведена полная интеграция форм регистрации и логина фронта с backend через эндпоинты /api/auth/register и /api/auth/login (через api-gateway).
- Исправлены все критические ошибки интеграции:
    - Исправлены пути проксирования в api-gateway (теперь регистрация и логин работают через /api/auth/register и /api/auth/login).
    - Исправлены модели и обработчики в api-gateway: теперь username подставляется автоматически, если не передан.
    - Исправлены ошибки с конфликтом моделей User (SQLAlchemy и Pydantic) в user-service.
    - Проведена полная диагностика и устранение ошибок docker-compose, пересборка контейнеров.
    - Проверена и подтверждена успешная регистрация и получение токена через curl.
- Зафиксировано: для получения токена после регистрации фронт должен делать отдельный запрос на логин.
- Доработан фронт: после успешной регистрации автоматически выполняется логин с теми же email и паролем, токены сохраняются, происходит редирект на /dashboard. Если логин не удался — показывается соответствующее сообщение.
- Чек-листы и документация обновлены: интеграция auth завершена, backend работает, фронт доработан.

---

## 2024-05-30

- Исправлен формат ответа /api/auth/login: теперь возвращается объект токена, а не массив.
- Фронт теперь автоматически логинит пользователя после регистрации, токен сохраняется, происходит редирект на /dashboard.
- Все интеграционные ошибки между фронтом, api-gateway и user-service устранены.
- Следующий шаг: добавить капчу на регистрацию и email-валидацию.

---

## 2024-05-31

- Реализованы полноценные формы логина и регистрации:
    - Валидация email, пароля, подтверждения пароля
    - Сообщения об ошибках
    - Loader на время запроса
    - Кнопка показать/скрыть пароль
    - Ссылки для перехода между логином и регистрацией
    - Современный визуал, адаптивность, доступность
- Следующий этап — интеграция с backend (API /api/auth/login, /api/auth/register), обработка ошибок, сохранение токенов, редиректы, защита роутов

## 2024-06-01

- Доработан Sidebar (левое меню) в пользовательском кабинете:
    - Sidebar теперь полностью адаптивен: на desktop всегда открыт, на мобильных скрывается и открывается по кнопке-гамбургеру
    - Реализован overlay и крестик для закрытия Sidebar на мобильных
    - Исправлено UX мобильного меню, устранены проблемы с невозможностью свернуть меню
    - Чек-листы и документация обновлены

---

(добавляйте новые записи по мере изменений)



